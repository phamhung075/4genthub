# Keycloak Service Account Configuration Sample
# Copy relevant values to your .env file

# =================================
# KEYCLOAK CONFIGURATION
# =================================

# Keycloak server URL (without trailing slash)
KEYCLOAK_URL=https://your-keycloak-instance.com

# Keycloak realm name
KEYCLOAK_REALM=4genthub

# =================================
# SERVICE ACCOUNT CONFIGURATION
# =================================

# Service account client ID (create in Keycloak admin console)
KEYCLOAK_SERVICE_CLIENT_ID=mcp-service-account

# Service account client secret (generate in Keycloak admin console)
KEYCLOAK_SERVICE_CLIENT_SECRET=your-service-account-secret-here

# Service account scopes (space-separated)
KEYCLOAK_SERVICE_SCOPES=openid profile email mcp:read mcp:write

# =================================
# AUTHENTICATION CONFIGURATION
# =================================

# Enable/disable authentication (true/false)
AUTH_ENABLED=true

# Token validation settings
TOKEN_CACHE_TTL=300
PUBLIC_KEY_CACHE_TTL=3600

# =================================
# SECURITY SETTINGS
# =================================

# SSL certificate verification (always true in production)
SSL_VERIFY=true

# Request rate limiting (requests per second)
RATE_LIMIT_RPS=10

# Token refresh buffer (seconds before expiry to refresh)
TOKEN_REFRESH_BUFFER=30

# =================================
# LOGGING CONFIGURATION
# =================================

# Log level for authentication (DEBUG, INFO, WARNING, ERROR)
AUTH_LOG_LEVEL=INFO

# Enable audit logging for authentication events
AUTH_AUDIT_ENABLED=true

# =================================
# SERVICE ACCOUNT SETUP INSTRUCTIONS
# =================================

# 1. Log into Keycloak Admin Console
# 2. Navigate to your realm (4genthub)
# 3. Go to Clients → Create Client
# 4. Set Client ID: mcp-service-account
# 5. Enable "Client authentication" (confidential client)
# 6. Enable "Service accounts roles"
# 7. Disable "Standard flow" and "Implicit flow" 
# 8. Set "Access Type" to "confidential"
# 9. Generate client secret in "Credentials" tab
# 10. Configure service account roles in "Service Account Roles" tab
# 11. Add required realm roles:
#     - mcp-admin (full access)
#     - mcp-tools (tool execution)
#     - mcp-user (basic access)
# 12. Add custom client scopes if needed:
#     - mcp:read (read operations)
#     - mcp:write (write operations)
#     - mcp:execute (tool execution)

# =================================
# REQUIRED KEYCLOAK ROLES
# =================================

# Create these roles in Keycloak realm:
# - mcp-admin: Full administrative access
# - mcp-tools: Access to execute MCP tools  
# - mcp-user: Basic read access
# - mcp-developer: Development and testing access

# =================================
# CLIENT SCOPE CONFIGURATION
# =================================

# Create custom client scopes:
# - mcp:read: Read access to resources
# - mcp:write: Write access to resources  
# - mcp:execute: Execute tools and operations
# - mcp:admin: Administrative operations

# Assign scopes to service account client:
# - Default scopes: openid, profile, email, mcp:read
# - Optional scopes: mcp:write, mcp:execute, mcp:admin

# =================================
# SECURITY RECOMMENDATIONS
# =================================

# 1. Use strong, unique client secrets
# 2. Rotate client secrets regularly (monthly recommended)
# 3. Limit service account permissions to minimum required
# 4. Enable audit logging for all authentication events
# 5. Monitor for unusual authentication patterns
# 6. Use HTTPS only (never HTTP in production)
# 7. Keep Keycloak instance updated and secured
# 8. Use environment-specific service accounts (dev/staging/prod)
# 9. Store secrets in secure secret management systems
# 10. Implement proper network security and access controls

# =================================
# TESTING CONFIGURATION
# =================================

# For development/testing, you can disable authentication:
# AUTH_ENABLED=false

# Test credentials (development only):
# KEYCLOAK_SERVICE_CLIENT_ID=mcp-service-test
# KEYCLOAK_SERVICE_CLIENT_SECRET=test-secret-do-not-use-in-production

# =================================
# TROUBLESHOOTING
# =================================

# Common issues and solutions:

# 1. "Client authentication failed"
#    → Check client_id and client_secret are correct
#    → Ensure client has "Service accounts roles" enabled
#    → Verify client access type is "confidential"

# 2. "Insufficient permissions"
#    → Check service account roles assignment
#    → Verify required scopes are granted to client
#    → Check client scope mappings

# 3. "SSL verification failed"
#    → Ensure KEYCLOAK_URL uses HTTPS
#    → Check SSL certificate validity
#    → Verify SSL_VERIFY setting

# 4. "Token expired" errors
#    → Check system time synchronization
#    → Verify TOKEN_REFRESH_BUFFER setting
#    → Monitor token lifetime settings in Keycloak

# 5. "Connection refused"
#    → Verify KEYCLOAK_URL is accessible
#    → Check firewall and network configuration
#    → Ensure Keycloak service is running

# =================================
# MONITORING AND METRICS
# =================================

# Monitor these metrics:
# - Authentication success/failure rates
# - Token refresh frequency
# - Service account usage patterns
# - SSL certificate expiry
# - Keycloak service health
# - Network connectivity to Keycloak

# Set up alerts for:
# - Authentication failures exceeding threshold
# - Token refresh failures
# - SSL certificate expiry warnings
# - Keycloak service downtime
# - Unusual service account activity