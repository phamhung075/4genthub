# Test Fix Instructions - Step by Step Process

## Objective
Fix all failing tests systematically by addressing root causes, not just symptoms.

## Step-by-Step Process

### Step 1: Load and Analyze Failed Tests
1. View failed tests using test-menu.sh:
   ```bash
   # Option 8: List all cached tests (shows failed and passed)
   echo -e "8\nq" | timeout 10 scripts/test-menu.sh

   # Option 7: Show cache statistics (see how many failed)
   echo -e "7\nq" | timeout 10 scripts/test-menu.sh
   ```
2. Pick the FIRST failing test from the failed list (shown in red with ✗)
3. Note the exact file path and test name

### Step 2: Investigate Root Cause
1. Run the specific test in isolation to see the exact error:
   ```bash
   # Using test-menu.sh option 4 (Recommended)
   echo -e "4\n[test_file_path]\nq" | timeout 20 scripts/test-menu.sh

   # Or direct pytest if needed for more control
   timeout 20 bash -c "cd dhafnck_mcp_main && python -m pytest [test_file_path]::[test_name] -xvs --tb=long"
   ```
2. Analyze the error message carefully
3. Identify the root cause (not just the symptom):
   - Import errors → Find missing module/class
   - Assertion errors → Understand expected vs actual behavior
   - Type errors → Check data types and interfaces
   - Dependency errors → Verify all dependencies exist

### Step 3: Fix the Root Cause
1. Navigate to the source of the problem (not just the test file)
2. Apply the fix to the SOURCE CODE, not the test
3. If test is outdated, update test to match current implementation
4. Document what was changed and why

### Step 4: Verify the Fix
1. Re-run the specific test to confirm it passes using test-menu.sh:
   ```bash
   # Use test-menu.sh option 4 for specific test file
   echo "4" | timeout 20 scripts/test-menu.sh
   # Then enter the test file path when prompted
   # Example: dhafnck_mcp_main/src/tests/unit/test_file.py
   ```
2. **IMPORTANT**: Use `timeout 20` to prevent infinite loops (20 second max)
3. Run related tests in the same module to ensure no regression
4. Check `.test_cache/passed_tests.txt` to confirm test was moved there
5. If test passes, proceed to next step

### Step 5: Update Test Cache (AUTOMATIC with test-menu.sh)
**Note: test-menu.sh handles this automatically!**
- When test **PASSES**: Automatically moved from `failed_tests.txt` to `passed_tests.txt`
- When test **FAILS**: Remains in `failed_tests.txt`
- Test hash is automatically updated in `test_hashes.txt`

**Manual update only needed if NOT using test-menu.sh:**
1. Remove the fixed test from `.test_cache/failed_tests.txt`
2. Add the test to `.test_cache/passed_tests.txt`
3. Update test hash in `.test_cache/test_hashes.txt`

### Step 6: Document and Continue
1. Log the fix in a tracking file with:
   - Test name
   - Root cause identified
   - Fix applied
   - Verification status
2. Return to Step 1 with the next failing test

## Important Guidelines

### DO:
- Fix the actual source code that causes test failures
- Address root causes in the implementation
- Update tests only if they're testing deprecated behavior
- Run each test in isolation first
- Verify fixes don't break other tests
- Keep detailed logs of each fix

### DON'T:
- Just modify tests to make them pass
- Apply quick patches without understanding the issue
- Skip verification steps
- Fix multiple tests simultaneously
- Ignore related test failures

## Current Status
- Total failing tests: Check `.test_cache/failed_tests.txt`
- Progress tracking: See fix logs
- Next test to fix: [First line in failed_tests.txt]

## How test-menu.sh Auto-Manages Cache

### Automatic Cache Operations:
1. **Running Tests (Options 1-4)**:
   - Captures pytest output in real-time
   - Parses PASSED/FAILED status for each test
   - Updates cache files immediately after test completes

2. **Cache Updates**:
   - **PASSED**: `mark_test_passed()` function:
     - Removes from `failed_tests.txt`
     - Adds to `passed_tests.txt`
     - Updates MD5 hash in `test_hashes.txt`
   - **FAILED**: `mark_test_failed()` function:
     - Removes from `passed_tests.txt`
     - Adds to `failed_tests.txt`
     - Keeps test ready for next iteration

3. **Smart Skipping (Option 1)**:
   - Checks if test is in `passed_tests.txt`
   - Verifies MD5 hash hasn't changed
   - Skips if both conditions met
   - Re-runs if file modified

4. **Cache Management (Options 5-6)**:
   - Option 5: Clear all cache (force full rerun)
   - Option 6: Clear failed tests only

## Command Reference

### Using test-menu.sh for Smart Testing (RECOMMENDED)
```bash
# Run test-menu.sh option 4 with timeout wrapper
echo -e "4\n[test_file_path]\nq" | timeout 20 scripts/test-menu.sh

# Example for specific test file:
echo -e "4\ndhafnck_mcp_main/src/tests/unit/database_config_test.py\nq" | timeout 20 scripts/test-menu.sh

# Run failed tests only (option 2) with timeout
echo -e "2\nq" | timeout 20 scripts/test-menu.sh

# Check test statistics (option 7)
echo -e "7\nq" | timeout 10 scripts/test-menu.sh

# View cached passed/failed tests (option 8)
echo -e "8\nq" | timeout 10 scripts/test-menu.sh
```

### Direct pytest commands (fallback if test-menu.sh fails)
```bash
# Run single test with timeout
timeout 20 bash -c "cd dhafnck_mcp_main && python -m pytest [test_path]::[test_name] -xvs"

# Run all tests in a file
timeout 20 bash -c "cd dhafnck_mcp_main && python -m pytest [test_path] -xvs"

# Check test with detailed traceback
timeout 20 bash -c "cd dhafnck_mcp_main && python -m pytest [test_path]::[test_name] -xvs --tb=long"

# Run with coverage
timeout 60 bash -c "cd dhafnck_mcp_main && python -m pytest [test_path] --cov=[module] --cov-report=term-missing"
```

### Timeout Prevention Strategy
- **Always use `timeout` command** to prevent infinite test loops
- **Standardized timeout: 20 seconds** for most operations
- **Extended timeout: 60 seconds** only for coverage reports
- **Quick operations: 10 seconds** for stats and cache viewing
- **If test hangs**: Kill with Ctrl+C or wait for timeout
- **Check `.test_cache/last_run.log`** for test output after timeout

### Test Cache Files Reference
- `.test_cache/passed_tests.txt` - Tests that have passed
- `.test_cache/failed_tests.txt` - Tests that need fixing
- `.test_cache/test_hashes.txt` - MD5 hashes to detect file changes
- `.test_cache/last_run.log` - Output from last test run
- `.test_cache/stats.txt` - Test statistics