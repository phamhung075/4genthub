# Cache bust: 1757949769
# Production Frontend Dockerfile for agenthub
# Multi-stage build optimized for production deployment
# Features: Minimal image size, optimized assets, security hardening, multi-platform support
# Version: 2.3.0 - Optimized for ARM64 native builds (M1/M2 Macs) (2025-09-17)
#
# IMPORTANT: This Dockerfile is configured for linux/arm64 (ARM64) architecture
# - Best performance on M1/M2 Macs and ARM-based servers
# - For x86_64/AMD64 deployments, change platform to linux/amd64

# syntax=docker/dockerfile:1
# Enable BuildKit for multi-platform builds

# Stage 1: Builder
# Using linux/arm64 for native ARM64 builds (M1/M2 Macs)
FROM --platform=linux/arm64 node:20-alpine AS builder

WORKDIR /build

# Copy package files (project uses pnpm)
COPY agenthub-frontend/package.json ./

# Install all dependencies (including dev dependencies for build)
# Install pnpm globally
RUN npm install -g pnpm

# Copy pnpm-lock.yaml
COPY agenthub-frontend/pnpm-lock.yaml ./

# Install dependencies with pnpm
RUN pnpm install --frozen-lockfile

# Copy source code
COPY agenthub-frontend/ .

# Build arguments grouped by frequency of change (optimization for Docker layer caching)
# Group 1: Static/Rarely Changed - Environment type, ports, defaults
ARG NODE_ENV=production
ARG VITE_ENV=production
ARG ENV=production
ARG FRONTEND_PORT=3800
ARG APP_DEBUG=false
ARG APP_LOG_LEVEL=INFO

# Group 2: Feature Flags/Config - WebSocket and logging settings (change occasionally)
ARG VITE_WS_MAX_RECONNECT_ATTEMPTS=5
ARG VITE_WS_RECONNECT_DELAY=1000
ARG VITE_WS_AI_BUFFER_TIMEOUT=500
ARG VITE_WS_MAX_RECONNECT_DELAY=30000
ARG VITE_WS_HEARTBEAT_INTERVAL=30000
ARG VITE_LOG_ENABLED=true
ARG VITE_LOG_LEVEL=error
ARG VITE_LOG_SHOW_TIMESTAMP=true
ARG VITE_LOG_SHOW_LEVEL=true
ARG VITE_LOG_SHOW_FILE_PATH=false
ARG VITE_LOG_COLORIZE=false
ARG VITE_LOG_TO_CONSOLE=true
ARG VITE_LOG_TO_LOCALSTORAGE=false
ARG VITE_LOG_TO_REMOTE=false
ARG VITE_LOG_REMOTE_ENDPOINT=
ARG VITE_LOG_MAX_STORAGE_SIZE=1048576

# Group 3: External Services - URLs and connection settings (change per deployment)
ARG VITE_API_URL
ARG VITE_BACKEND_URL
ARG VITE_WS_URL
ARG VITE_KEYCLOAK_URL
ARG VITE_KEYCLOAK_REALM
ARG VITE_KEYCLOAK_CLIENT_ID

# Group 4: Build Metadata - Changes with every build (most frequently changed)
ARG VITE_BUILD_TIME
ARG VITE_BUILD_SHA
ARG CAPROVER_GIT_COMMIT_SHA

# Build-time environment variables - use actual values or defaults
# These are used during build but can be overridden at runtime via env-config.js
# IMPORTANT: Use build args if provided, otherwise use localhost for local testing
ENV VITE_API_URL=${VITE_API_URL:-http://localhost:8000}
ENV VITE_BACKEND_URL=${VITE_BACKEND_URL:-http://localhost:8000}
ENV VITE_KEYCLOAK_URL=${VITE_KEYCLOAK_URL:-}
ENV VITE_KEYCLOAK_REALM=${VITE_KEYCLOAK_REALM:-}
ENV VITE_KEYCLOAK_CLIENT_ID=${VITE_KEYCLOAK_CLIENT_ID:-mcp-frontend}
ENV VITE_ENV=${VITE_ENV}
ENV VITE_BUILD_TIME=${VITE_BUILD_TIME}
ENV VITE_BUILD_SHA=${VITE_BUILD_SHA}
ENV NODE_ENV=${NODE_ENV}

# WebSocket environment variables for build-time
ENV VITE_WS_URL=${VITE_WS_URL:-}
ENV VITE_WS_MAX_RECONNECT_ATTEMPTS=${VITE_WS_MAX_RECONNECT_ATTEMPTS}
ENV VITE_WS_RECONNECT_DELAY=${VITE_WS_RECONNECT_DELAY}
ENV VITE_WS_AI_BUFFER_TIMEOUT=${VITE_WS_AI_BUFFER_TIMEOUT}
ENV VITE_WS_MAX_RECONNECT_DELAY=${VITE_WS_MAX_RECONNECT_DELAY}
ENV VITE_WS_HEARTBEAT_INTERVAL=${VITE_WS_HEARTBEAT_INTERVAL}

# Logging environment variables for build-time
ENV VITE_LOG_ENABLED=${VITE_LOG_ENABLED}
ENV VITE_LOG_LEVEL=${VITE_LOG_LEVEL}
ENV VITE_LOG_SHOW_TIMESTAMP=${VITE_LOG_SHOW_TIMESTAMP}
ENV VITE_LOG_SHOW_LEVEL=${VITE_LOG_SHOW_LEVEL}
ENV VITE_LOG_SHOW_FILE_PATH=${VITE_LOG_SHOW_FILE_PATH}
ENV VITE_LOG_COLORIZE=${VITE_LOG_COLORIZE}
ENV VITE_LOG_TO_CONSOLE=${VITE_LOG_TO_CONSOLE}
ENV VITE_LOG_TO_LOCALSTORAGE=${VITE_LOG_TO_LOCALSTORAGE}
ENV VITE_LOG_TO_REMOTE=${VITE_LOG_TO_REMOTE}
ENV VITE_LOG_REMOTE_ENDPOINT=${VITE_LOG_REMOTE_ENDPOINT}
ENV VITE_LOG_MAX_STORAGE_SIZE=${VITE_LOG_MAX_STORAGE_SIZE}

# Build the application with production optimizations
RUN pnpm run build

# Stage 2: Production Runtime with Nginx
# Using linux/arm64 for native ARM64 builds (M1/M2 Macs)
FROM --platform=linux/arm64 nginx:alpine

# Runtime arguments grouped by frequency of change (optimization for Docker layer caching)
# Group 1: Static/Rarely Changed - Environment type, ports, defaults
ARG FRONTEND_PORT=3800
ARG ENV=production

# Group 2: Feature Flags/Config - WebSocket and logging settings (change occasionally)
ARG VITE_WS_MAX_RECONNECT_ATTEMPTS=5
ARG VITE_WS_RECONNECT_DELAY=1000
ARG VITE_WS_AI_BUFFER_TIMEOUT=500
ARG VITE_WS_MAX_RECONNECT_DELAY=30000
ARG VITE_WS_HEARTBEAT_INTERVAL=30000
ARG VITE_LOG_ENABLED=true
ARG VITE_LOG_LEVEL=error
ARG VITE_LOG_SHOW_TIMESTAMP=true
ARG VITE_LOG_SHOW_LEVEL=true
ARG VITE_LOG_SHOW_FILE_PATH=false
ARG VITE_LOG_COLORIZE=false
ARG VITE_LOG_TO_CONSOLE=true
ARG VITE_LOG_TO_LOCALSTORAGE=false
ARG VITE_LOG_TO_REMOTE=false
ARG VITE_LOG_REMOTE_ENDPOINT=
ARG VITE_LOG_MAX_STORAGE_SIZE=1048576

# Group 3: External Services - URLs and connection settings (change per deployment)
ARG VITE_API_URL
ARG VITE_BACKEND_URL
ARG VITE_WS_URL
ARG VITE_KEYCLOAK_URL
ARG VITE_KEYCLOAK_REALM
ARG VITE_KEYCLOAK_CLIENT_ID

# Group 4: Build Metadata - Changes with every build (most frequently changed)
ARG CAPROVER_GIT_COMMIT_SHA

# Install curl and setup nginx config (optimized single layer)
RUN apk add --no-cache curl && \
    rm -rf /etc/nginx/conf.d/*

# Create nginx config template for runtime customization
RUN printf 'server {\n    listen 3800;\n    listen [::]:3800;\n    server_name _;\n\n    root /usr/share/nginx/html;\n    index index.html;\n\n    # Security headers\n    add_header X-Frame-Options "SAMEORIGIN" always;\n    add_header X-Content-Type-Options "nosniff" always;\n    add_header X-XSS-Protection "1; mode=block" always;\n    add_header Referrer-Policy "strict-origin-when-cross-origin" always;\n    add_header Content-Security-Policy "default-src '\''self'\''; script-src '\''self'\'' '\''unsafe-inline'\'' '\''unsafe-eval'\''; style-src '\''self'\'' '\''unsafe-inline'\''; img-src '\''self'\'' data: https:; font-src '\''self'\'' data:; connect-src '\''self'\'' ${VITE_API_URL} ${VITE_BACKEND_URL} ${VITE_KEYCLOAK_URL};" always;\n\n    # Gzip compression\n    gzip on;\n    gzip_vary on;\n    gzip_min_length 1024;\n    gzip_types text/plain text/css text/xml text/javascript application/javascript application/xml+rss application/json application/font-woff application/font-woff2;\n\n    # Cache static assets\n    location ~* \\.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {\n        expires 1y;\n        add_header Cache-Control "public, immutable";\n    }\n\n    # Don'\''t cache HTML (for updates)\n    location ~* \\.(html)$ {\n        expires -1;\n        add_header Cache-Control "no-cache, no-store, must-revalidate";\n    }\n\n    # SPA routing - serve index.html for all routes\n    location / {\n        try_files $uri $uri/ /index.html;\n    }\n\n    # Health check endpoint\n    location /health {\n        access_log off;\n        return 200 "healthy\\n";\n        add_header Content-Type text/plain;\n    }\n\n    # Disable access to hidden files\n    location ~ /\\. {\n        deny all;\n        access_log off;\n        log_not_found off;\n    }\n}\n' > /etc/nginx/conf.d/default.conf.template

# Create startup script and set permissions (optimized single layer)
RUN printf '#!/bin/sh\nset -e\n\necho "Starting agenthub Frontend Production Server..."\necho "================================================"\n\n# Validate required environment variables\nREQUIRED_VARS="VITE_API_URL VITE_BACKEND_URL"\nMISSING_VARS=""\n\nfor VAR in $REQUIRED_VARS; do\n    eval VALUE=\\$$VAR\n    if [ -z "$VALUE" ]; then\n        MISSING_VARS="$MISSING_VARS $VAR"\n        echo "âŒ Missing required variable: $VAR"\n    else\n        echo "âœ… $VAR configured"\n    fi\ndone\n\nif [ -n "$MISSING_VARS" ]; then\n    echo ""\n    echo "âŒ ERROR: Missing required environment variables:$MISSING_VARS"\n    exit 1\nfi\n\n# Validate Keycloak configuration\nif [ -n "$VITE_KEYCLOAK_URL" ] && [ -n "$VITE_KEYCLOAK_REALM" ] && [ -n "$VITE_KEYCLOAK_CLIENT_ID" ]; then\n    echo "âœ… Keycloak authentication configured"\nelse\n    echo "âš ï¸  WARNING: Keycloak not fully configured - authentication may not work"\nfi\n\necho ""\necho "Configuration Summary:"\necho "  Backend URL: ${VITE_BACKEND_URL}"\necho "  API URL: ${VITE_API_URL}"\necho "  Environment: production"\necho "  Port: 3800"\necho "================================================"\n\n# Create runtime env-config.js for the app\ncat > /usr/share/nginx/html/env-config.js <<EOL\n// Runtime configuration - injected at container startup\nwindow._env_ = {\n  VITE_API_URL: '\''${VITE_API_URL:-http://localhost:8000}'\'',\n  VITE_BACKEND_URL: '\''${VITE_BACKEND_URL:-${VITE_API_URL:-http://localhost:8000}}'\'',\n  VITE_KEYCLOAK_URL: '\''${VITE_KEYCLOAK_URL:-}'\'',\n  VITE_KEYCLOAK_REALM: '\''${VITE_KEYCLOAK_REALM:-}'\'',\n  VITE_KEYCLOAK_CLIENT_ID: '\''${VITE_KEYCLOAK_CLIENT_ID:-}'\'',\n  VITE_ENV: '\''${VITE_ENV:-production}'\'',\n  VITE_DEBUG: '\''${VITE_DEBUG:-false}'\'',\n  VITE_APP_NAME: '\''${VITE_APP_NAME:-agenthub}'\'',\n  VITE_WS_URL: '\''${VITE_WS_URL:-}'\'',\n  VITE_WS_MAX_RECONNECT_ATTEMPTS: '\''${VITE_WS_MAX_RECONNECT_ATTEMPTS:-5}'\'',\n  VITE_WS_RECONNECT_DELAY: '\''${VITE_WS_RECONNECT_DELAY:-1000}'\'',\n  VITE_WS_AI_BUFFER_TIMEOUT: '\''${VITE_WS_AI_BUFFER_TIMEOUT:-500}'\'',\n  VITE_WS_MAX_RECONNECT_DELAY: '\''${VITE_WS_MAX_RECONNECT_DELAY:-30000}'\'',\n  VITE_WS_HEARTBEAT_INTERVAL: '\''${VITE_WS_HEARTBEAT_INTERVAL:-30000}'\'',\n  VITE_LOG_ENABLED: '\''${VITE_LOG_ENABLED:-true}'\'',\n  VITE_LOG_LEVEL: '\''${VITE_LOG_LEVEL:-error}'\'',\n  VITE_LOG_SHOW_TIMESTAMP: '\''${VITE_LOG_SHOW_TIMESTAMP:-true}'\'',\n  VITE_LOG_SHOW_LEVEL: '\''${VITE_LOG_SHOW_LEVEL:-true}'\'',\n  VITE_LOG_SHOW_FILE_PATH: '\''${VITE_LOG_SHOW_FILE_PATH:-false}'\'',\n  VITE_LOG_COLORIZE: '\''${VITE_LOG_COLORIZE:-false}'\'',\n  VITE_LOG_TO_CONSOLE: '\''${VITE_LOG_TO_CONSOLE:-true}'\'',\n  VITE_LOG_TO_LOCALSTORAGE: '\''${VITE_LOG_TO_LOCALSTORAGE:-false}'\'',\n  VITE_LOG_TO_REMOTE: '\''${VITE_LOG_TO_REMOTE:-false}'\'',\n  VITE_LOG_REMOTE_ENDPOINT: '\''${VITE_LOG_REMOTE_ENDPOINT:-}'\'',\n  VITE_LOG_MAX_STORAGE_SIZE: '\''${VITE_LOG_MAX_STORAGE_SIZE:-1048576}'\''\n};\nEOL\n\n# Replace environment variables in nginx config template\nenvsubst '\''${VITE_API_URL} ${VITE_BACKEND_URL} ${VITE_KEYCLOAK_URL}'\'' < /etc/nginx/conf.d/default.conf.template > /etc/nginx/conf.d/default.conf\n\n# Create runtime config file for the app (legacy format)\ncat > /usr/share/nginx/html/config.json <<EOL\n{\n  "apiUrl": "${VITE_API_URL}",\n  "backendUrl": "${VITE_BACKEND_URL}",\n  "keycloakUrl": "${VITE_KEYCLOAK_URL}",\n  "keycloakRealm": "${VITE_KEYCLOAK_REALM}",\n  "keycloakClientId": "${VITE_KEYCLOAK_CLIENT_ID}",\n  "environment": "production"\n}\nEOL\n\necho ""\necho "ðŸš€ Starting nginx server on port 3800..."\nexec nginx -g '\''daemon off;'\''\n' > /docker-entrypoint.sh && \
    chmod +x /docker-entrypoint.sh

# Copy built application from builder
COPY --from=builder /build/build /usr/share/nginx/html

# Create non-root user for nginx
RUN addgroup -g 1001 -S nginx-group && \
    adduser -S -D -H -u 1001 -h /var/cache/nginx -s /sbin/nologin -G nginx-group -g nginx nginx-user && \
    chown -R nginx-user:nginx-group /usr/share/nginx/html /var/cache/nginx /var/log/nginx /etc/nginx/conf.d

# Use non-root user
USER nginx-user

EXPOSE 3800

# Health check
HEALTHCHECK --interval=30s --timeout=3s --start-period=30s --retries=3 \
    CMD curl -f http://localhost:3800/health || exit 1

ENTRYPOINT ["/docker-entrypoint.sh"]