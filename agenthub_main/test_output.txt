Could not import from test fixtures: No module named 'fixtures.mocks'
Falling back to copied implementations in fixtures directory
Could not import mock implementations from any location
Defining minimal mock implementations inline
2025-08-27 02:49:51,739 - fastmcp.task_management.infrastructure.repositories.git_branch_repository_factory - INFO - Registered git branch repository type: orm
2025-08-27 02:49:51,739 - fastmcp.task_management.infrastructure.repositories.git_branch_repository_factory - INFO - Registered git branch repository type: memory
üöÄ Manual Completion Summary Context Storage Test
============================================================
üß™ Testing completion_summary context storage...
2025-08-27 02:49:51,751 - fastmcp.task_management.infrastructure.database.database_config - INFO - üì¶ Using SQLite for test execution (test mode detected)
2025-08-27 02:49:51,751 - fastmcp.task_management.infrastructure.database.database_source_manager - INFO - Detected TEST mode (pytest)
2025-08-27 02:49:51,752 - fastmcp.task_management.infrastructure.database.database_source_manager - INFO - Database path set to: ./agenthub_main/database/data/agenthub_test.db
2025-08-27 02:49:51,752 - fastmcp.task_management.infrastructure.database.database_config - INFO - üì¶ Using SQLite database for tests: ./agenthub_main/database/data/agenthub_test.db
2025-08-27 02:49:51,752 - fastmcp.task_management.infrastructure.database.database_config - INFO - üì¶ Creating SQLite engine for test execution
2025-08-27 02:49:51,756 - fastmcp.task_management.infrastructure.database.database_config - INFO - ‚úÖ SQLite engine created for tests
2025-08-27 02:49:51,758 - fastmcp.task_management.infrastructure.database.database_config - INFO - üì¶ Connected to SQLite: 3.45.1
‚úÖ Database connected and schema initialized
2025-08-27 02:49:51,759 - fastmcp.task_management.infrastructure.repositories.base_user_scoped_repository - INFO - Repository initialized in system mode during startup - no user filtering applied (expected behavior)
2025-08-27 02:49:51,759 - fastmcp.task_management.infrastructure.repositories.base_user_scoped_repository - INFO - Repository initialized in system mode during startup - no user filtering applied (expected behavior)
2025-08-27 02:49:51,759 - fastmcp.task_management.application.services.context_cache_service - INFO - ContextCacheService initialized with 1h TTL
2025-08-27 02:49:51,759 - fastmcp.task_management.application.services.context_inheritance_service - INFO - ContextInheritanceService initialized
2025-08-27 02:49:51,759 - fastmcp.task_management.application.services.context_delegation_service - INFO - ContextDelegationService initialized
2025-08-27 02:49:51,759 - fastmcp.task_management.application.factories.unified_context_facade_factory - INFO - UnifiedContextFacadeFactory initialized with database
DEBUG FACADE INIT: context_service type: <class 'NoneType'>
DEBUG FACADE INIT: hierarchical_context_service type: <class 'fastmcp.task_management.application.services.unified_context_service.UnifiedContextService'>
‚úÖ Created test project: da0c0d94-6da4-4ae3-aa47-b4dc11981cda
‚úÖ Created test branch: 25b7df2a-2854-4121-9028-b8905fd7b5e5
‚úÖ Branch verification: Found branch test-completion-summary in project da0c0d94-6da4-4ae3-aa47-b4dc11981cda
2025-08-27 02:49:51,774 - fastmcp.task_management.infrastructure.repositories.project_repository_factory - INFO - üîç Project Repository Factory: Creating repository with user_id: test-user-123
2025-08-27 02:49:51,774 - fastmcp.task_management.infrastructure.repositories.project_repository_factory - INFO - üîß Repository type: None, db_path: None
DEBUG: ProjectRepositoryFactory.create called with user_id=test-user-123
2025-08-27 02:49:51,774 - fastmcp.task_management.infrastructure.repositories.project_repository_factory - INFO - ‚úÖ Project Repository Factory: Using provided user_id: test-user-123
2025-08-27 02:49:51,774 - fastmcp.task_management.infrastructure.repositories.base_user_scoped_repository - INFO - Repository initialized in system mode during startup - no user filtering applied (expected behavior)
2025-08-27 02:49:51,774 - fastmcp.task_management.infrastructure.repositories.project_repository_factory - INFO - Created repository: orm for user: test-user-123
üîç Debug: git_branch_exists('25b7df2a-2854-4121-9028-b8905fd7b5e5') = False
‚ö†Ô∏è  Working around git_branch_exists issue by temporarily bypassing validation
üîç Debug: Creating task with git_branch_id='25b7df2a-2854-4121-9028-b8905fd7b5e5' (type: <class 'str'>)
üîç Debug: Creating task with user_id='test-user-123' (type: <class 'str'>)
üîç Debug: Request object git_branch_id='25b7df2a-2854-4121-9028-b8905fd7b5e5' (type: <class 'str'>)
üîç Debug: Request object user_id='test-user-123' (type: <class 'str'>)
üîç Debug: About to execute create task use case
üîç CREATE TASK: request.git_branch_id = '25b7df2a-2854-4121-9028-b8905fd7b5e5' (type: <class 'str'>)
üîç CREATE TASK: task_id = '3b7e469d-989c-43ae-893c-8d5cd703ad6e' (type: <class 'fastmcp.task_management.domain.value_objects.task_id.TaskId'>)
üîç BEFORE Task.create(): git_branch_id_param = '25b7df2a-2854-4121-9028-b8905fd7b5e5' (type: <class 'str'>)
üîç AFTER Task.create(): task.git_branch_id = '25b7df2a-2854-4121-9028-b8905fd7b5e5' (type: <class 'str'>)
üîç CREATED TASK: task.id = '3b7e469d-989c-43ae-893c-8d5cd703ad6e' (type: <class 'fastmcp.task_management.domain.value_objects.task_id.TaskId'>)
üîç DEBUG SAVE: task.id = '3b7e469d-989c-43ae-893c-8d5cd703ad6e' (type: <class 'fastmcp.task_management.domain.value_objects.task_id.TaskId'>)
üîç DEBUG SAVE: str(task.id) = '3b7e469d-989c-43ae-893c-8d5cd703ad6e'
üîç DEBUG SAVE: task.git_branch_id = '25b7df2a-2854-4121-9028-b8905fd7b5e5' (type: <class 'str'>)
üîç DEBUG SAVE: task.id.value = '3b7e469d-989c-43ae-893c-8d5cd703ad6e'
üîç DEBUG SAVE: task_id_str after str() = '3b7e469d-989c-43ae-893c-8d5cd703ad6e'
üîç DEBUG SAVE: new_task.id (ORM) = '3b7e469d-989c-43ae-893c-8d5cd703ad6e'
üîç DEBUG SAVE: new_task.git_branch_id (ORM) = '25b7df2a-2854-4121-9028-b8905fd7b5e5'
2025-08-27 02:49:51,901 - fastmcp.task_management.infrastructure.repositories.orm.task_repository - ERROR - Failed to save task: (sqlite3.IntegrityError) FOREIGN KEY constraint failed
[SQL: INSERT INTO tasks (id, title, description, git_branch_id, status, priority, details, estimated_effort, due_date, created_at, updated_at, completed_at, completion_summary, testing_notes, context_id, progress_percentage, user_id) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)]
[parameters: ('3b7e469d989c43ae893c8d5cd703ad6e', 'Test completion summary storage', 'Testing that completion_summary is stored in context', '25b7df2a285441219028b8905fd7b5e5', 'todo', 'medium', '', '', None, '2025-08-27 00:49:51.898861', '2025-08-27 00:49:51.898861', None, '', '', None, 0, 'testuser123')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-08-27 02:49:51,905 - fastmcp.task_management.infrastructure.repositories.orm.task_repository - ERROR - Traceback: Traceback (most recent call last):
  File "/home/daihungpham/.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/home/daihungpham/.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: FOREIGN KEY constraint failed

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "./agenthub_main/src/fastmcp/task_management/infrastructure/repositories/orm/task_repository.py", line 794, in save
    session.commit()
  File "/home/daihungpham/.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/home/daihungpham/.local/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/home/daihungpham/.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/home/daihungpham/.local/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/home/daihungpham/.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/home/daihungpham/.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/home/daihungpham/.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/home/daihungpham/.local/lib/python3.12/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/home/daihungpham/.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/home/daihungpham/.local/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/home/daihungpham/.local/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/home/daihungpham/.local/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/home/daihungpham/.local/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py", line 1048, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/home/daihungpham/.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/home/daihungpham/.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/daihungpham/.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/home/daihungpham/.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/daihungpham/.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/home/daihungpham/.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/home/daihungpham/.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/home/daihungpham/.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) FOREIGN KEY constraint failed
[SQL: INSERT INTO tasks (id, title, description, git_branch_id, status, priority, details, estimated_effort, due_date, created_at, updated_at, completed_at, completion_summary, testing_notes, context_id, progress_percentage, user_id) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)]
[parameters: ('3b7e469d989c43ae893c8d5cd703ad6e', 'Test completion summary storage', 'Testing that completion_summary is stored in context', '25b7df2a285441219028b8905fd7b5e5', 'todo', 'medium', '', '', None, '2025-08-27 00:49:51.898861', '2025-08-27 00:49:51.898861', None, '', '', None, 0, 'testuser123')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)

2025-08-27 02:49:51,905 - root - ERROR - Failed to create task: (sqlite3.IntegrityError) FOREIGN KEY constraint failed
[SQL: INSERT INTO tasks (id, title, description, git_branch_id, status, priority, details, estimated_effort, due_date, created_at, updated_at, completed_at, completion_summary, testing_notes, context_id, progress_percentage, user_id) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)]
[parameters: ('3b7e469d989c43ae893c8d5cd703ad6e', 'Test completion summary storage', 'Testing that completion_summary is stored in context', '25b7df2a285441219028b8905fd7b5e5', 'todo', 'medium', '', '', None, '2025-08-27 00:49:51.898861', '2025-08-27 00:49:51.898861', None, '', '', None, 0, 'testuser123')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-08-27 02:49:51,906 - root - ERROR - Traceback: Traceback (most recent call last):
  File "/home/daihungpham/.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/home/daihungpham/.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: FOREIGN KEY constraint failed

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "./agenthub_main/src/fastmcp/task_management/application/use_cases/create_task.py", line 90, in execute
    save_result = self._task_repository.save(task)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "./agenthub_main/src/fastmcp/task_management/infrastructure/repositories/orm/task_repository.py", line 794, in save
    session.commit()
  File "/home/daihungpham/.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/home/daihungpham/.local/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/home/daihungpham/.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/home/daihungpham/.local/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/home/daihungpham/.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/home/daihungpham/.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/home/daihungpham/.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/home/daihungpham/.local/lib/python3.12/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/home/daihungpham/.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/home/daihungpham/.local/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/home/daihungpham/.local/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/home/daihungpham/.local/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/home/daihungpham/.local/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py", line 1048, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/home/daihungpham/.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/home/daihungpham/.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/daihungpham/.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/home/daihungpham/.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/daihungpham/.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/home/daihungpham/.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/home/daihungpham/.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/home/daihungpham/.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) FOREIGN KEY constraint failed
[SQL: INSERT INTO tasks (id, title, description, git_branch_id, status, priority, details, estimated_effort, due_date, created_at, updated_at, completed_at, completion_summary, testing_notes, context_id, progress_percentage, user_id) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)]
[parameters: ('3b7e469d989c43ae893c8d5cd703ad6e', 'Test completion summary storage', 'Testing that completion_summary is stored in context', '25b7df2a285441219028b8905fd7b5e5', 'todo', 'medium', '', '', None, '2025-08-27 00:49:51.898861', '2025-08-27 00:49:51.898861', None, '', '', None, 0, 'testuser123')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)

Traceback (most recent call last):
  File "./agenthub_main/src/tests/unit/task_management/test_completion_summary_manual.py", line 158, in test_completion_summary_storage
    raise AssertionError(f"Task creation failed: {created_task_response.message}")
AssertionError: Task creation failed: Failed to create task: (sqlite3.IntegrityError) FOREIGN KEY constraint failed
[SQL: INSERT INTO tasks (id, title, description, git_branch_id, status, priority, details, estimated_effort, due_date, created_at, updated_at, completed_at, completion_summary, testing_notes, context_id, progress_percentage, user_id) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)]
[parameters: ('3b7e469d989c43ae893c8d5cd703ad6e', 'Test completion summary storage', 'Testing that completion_summary is stored in context', '25b7df2a285441219028b8905fd7b5e5', 'todo', 'medium', '', '', None, '2025-08-27 00:49:51.898861', '2025-08-27 00:49:51.898861', None, '', '', None, 0, 'testuser123')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
üîç Debug: Create task response success: False
‚ùå Task creation failed: Failed to create task: (sqlite3.IntegrityError) FOREIGN KEY constraint failed
[SQL: INSERT INTO tasks (id, title, description, git_branch_id, status, priority, details, estimated_effort, due_date, created_at, updated_at, completed_at, completion_summary, testing_notes, context_id, progress_percentage, user_id) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)]
[parameters: ('3b7e469d989c43ae893c8d5cd703ad6e', 'Test completion summary storage', 'Testing that completion_summary is stored in context', '25b7df2a285441219028b8905fd7b5e5', 'todo', 'medium', '', '', None, '2025-08-27 00:49:51.898861', '2025-08-27 00:49:51.898861', None, '', '', None, 0, 'testuser123')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
‚ùå Test failed with error: Task creation failed: Failed to create task: (sqlite3.IntegrityError) FOREIGN KEY constraint failed
[SQL: INSERT INTO tasks (id, title, description, git_branch_id, status, priority, details, estimated_effort, due_date, created_at, updated_at, completed_at, completion_summary, testing_notes, context_id, progress_percentage, user_id) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)]
[parameters: ('3b7e469d989c43ae893c8d5cd703ad6e', 'Test completion summary storage', 'Testing that completion_summary is stored in context', '25b7df2a285441219028b8905fd7b5e5', 'todo', 'medium', '', '', None, '2025-08-27 00:49:51.898861', '2025-08-27 00:49:51.898861', None, '', '', None, 0, 'testuser123')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)

üí• FAILURE: completion_summary context storage needs fixing - Task creation failed: Failed to create task: (sqlite3.IntegrityError) FOREIGN KEY constraint failed
[SQL: INSERT INTO tasks (id, title, description, git_branch_id, status, priority, details, estimated_effort, due_date, created_at, updated_at, completed_at, completion_summary, testing_notes, context_id, progress_percentage, user_id) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)]
[parameters: ('3b7e469d989c43ae893c8d5cd703ad6e', 'Test completion summary storage', 'Testing that completion_summary is stored in context', '25b7df2a285441219028b8905fd7b5e5', 'todo', 'medium', '', '', None, '2025-08-27 00:49:51.898861', '2025-08-27 00:49:51.898861', None, '', '', None, 0, 'testuser123')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
