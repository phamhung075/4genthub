
üß™ Starting agenthub Test Suite
üõ°Ô∏è  Test data isolation enabled
üßπ Automatic cleanup configured
============================= test session starts ==============================
platform linux -- Python 3.12.3, pytest-8.4.1, pluggy-1.6.0
rootdir: /home/daihungpham/__projects__/4genthub/agenthub_main/src/tests
configfile: pytest.ini
plugins: postgresql-7.0.2, cov-6.2.1, anyio-4.9.0, asyncio-1.0.0
asyncio: mode=Mode.STRICT, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collected 4493 items

src/tests/unit/agent_inheritance_test.py ........................        [  0%]
src/tests/unit/auth/application/services/test_auth_service.py .......... [  0%]
........................                                                 [  1%]
src/tests/unit/auth/auth_module_init_test.py ..............              [  1%]
src/tests/unit/auth/domain/entities/user_test.py ....................    [  2%]
src/tests/unit/auth/domain/services/jwt_service_test.py ................ [  2%]
........                                                                 [  2%]
src/tests/unit/auth/domain/services/password_service_test.py ........... [  2%]
................                                                         [  3%]
src/tests/unit/auth/domain/value_objects/email_test.py .............     [  3%]
src/tests/unit/auth/domain/value_objects/user_id_test.py ...........     [  3%]
src/tests/unit/auth/infrastructure/repositories/user_repository_test.py . [  3%]
........................                                                 [  4%]
src/tests/unit/auth/infrastructure/supabase_auth_test.py ............... [  4%]
........                                                                 [  4%]
src/tests/unit/auth/interface/auth_endpoints_test.py .............       [  5%]
src/tests/unit/auth/interface/fastapi_auth_test.py ...........           [  5%]
src/tests/unit/auth/mcp_integration/jwt_auth_backend_test.py ........... [  5%]
..................                                                       [  5%]
src/tests/unit/auth/mcp_integration/mcp_auth_middleware_test.py ........ [  6%]
...                                                                      [  6%]
src/tests/unit/auth/mcp_integration/repository_filter_test.py .......... [  6%]
.................                                                        [  6%]
src/tests/unit/auth/mcp_integration/server_config_test.py .............. [  7%]
.........                                                                [  7%]
src/tests/unit/auth/mcp_integration/test_auth_fix_verification.py ...... [  7%]
                                                                         [  7%]
src/tests/unit/auth/middleware/dual_auth_middleware_test.py ............ [  7%]
.................                                                        [  8%]
src/tests/unit/auth/middleware/middleware_init_test.py .......           [  8%]
src/tests/unit/auth/middleware/test_jwt_auth_middleware.py ............. [  8%]
.............                                                            [  8%]
src/tests/unit/auth/services/auth_services_module_init_test.py ......... [  9%]
...........                                                              [  9%]
src/tests/unit/auth/services/mcp_token_service_test.py ................. [  9%]
......                                                                   [  9%]
src/tests/unit/auth/test_jwt_auth_backend_properties.py .....            [  9%]
src/tests/unit/auth/test_token_extraction.py .......                     [ 10%]
src/tests/unit/auth/token_validator_test.py .........................    [ 10%]
src/tests/unit/auth/websocket_security_test.py ......                    [ 10%]
src/tests/unit/connection_management/application/facades/connection_application_facade_test.py . [ 10%]
.................                                                        [ 11%]
src/tests/unit/connection_management/application/use_cases/test_check_connection_health.py . [ 11%]
.........                                                                [ 11%]
src/tests/unit/connection_management/application/use_cases/test_check_server_health.py . [ 11%]
........                                                                 [ 11%]
src/tests/unit/connection_management/application/use_cases/test_get_server_capabilities.py . [ 11%]
........                                                                 [ 11%]
src/tests/unit/connection_management/application/use_cases/test_get_server_status.py . [ 11%]
...........                                                              [ 12%]
src/tests/unit/connection_management/application/use_cases/test_register_status_updates.py . [ 12%]
...........                                                              [ 12%]
src/tests/unit/connection_management/domain/entities/connection_test.py . [ 12%]
............                                                             [ 12%]
src/tests/unit/connection_management/domain/entities/server_test.py .... [ 12%]
.....                                                                    [ 12%]
src/tests/unit/connection_management/domain/events/connection_events_test.py . [ 12%]
......................                                                   [ 13%]
src/tests/unit/connection_management/domain/exceptions/connection_exceptions_test.py . [ 13%]
............................                                             [ 13%]
src/tests/unit/connection_management/domain/repositories/connection_repository_test.py . [ 13%]
.......................                                                  [ 14%]
src/tests/unit/connection_management/domain/repositories/server_repository_test.py . [ 14%]
......................                                                   [ 15%]
src/tests/unit/connection_management/domain/services/connection_diagnostics_service_test.py . [ 15%]
.........                                                                [ 15%]
src/tests/unit/connection_management/domain/services/server_health_service_test.py . [ 15%]
........                                                                 [ 15%]
src/tests/unit/connection_management/domain/services/status_broadcasting_service_test.py . [ 15%]
.............................                                            [ 16%]
src/tests/unit/connection_management/domain/value_objects/connection_health_test.py . [ 16%]
.........                                                                [ 16%]
src/tests/unit/connection_management/domain/value_objects/server_capabilities_test.py . [ 16%]
..............                                                           [ 16%]
src/tests/unit/connection_management/domain/value_objects/server_status_test.py . [ 16%]
..........                                                               [ 16%]
src/tests/unit/connection_management/domain/value_objects/status_update_test.py . [ 16%]
...............                                                          [ 17%]
src/tests/unit/mcp_auto_injection/test_session_hooks.py ................ [ 17%]
..................                                                       [ 18%]
src/tests/unit/mcp_controllers/test_project_mcp_controller.py .......... [ 18%]
.......................                                                  [ 18%]
src/tests/unit/mcp_controllers/test_task_mcp_controller.py ............. [ 19%]
.....................                                                    [ 19%]
src/tests/unit/mcp_controllers/test_task_mcp_controller_complete.py .... [ 19%]
..........................................                               [ 20%]
src/tests/unit/services/test_context_field_selector.py ..............    [ 20%]
src/tests/unit/services/test_context_template_manager.py ..............  [ 21%]
src/tests/unit/services/test_optimization_integration.py .........       [ 21%]
src/tests/unit/services/test_response_formatter_optimization.py ........ [ 21%]
......                                                                   [ 21%]
src/tests/unit/services/test_response_profiles.py ..............         [ 21%]
src/tests/unit/task_management/application/dtos/context/context_request_test.py . [ 21%]
........................                                                 [ 22%]
src/tests/unit/task_management/application/dtos/task/create_task_request_test.py . [ 22%]
...........                                                              [ 22%]
src/tests/unit/task_management/application/dtos/task/test_progress_history_fix.py . [ 22%]
.                                                                        [ 22%]
src/tests/unit/task_management/application/facades/git_branch_application_facade_test.py . [ 22%]
...F
üßπ Performing final test data cleanup...
üßπ Final cleanup completed:
   - 0 test data files removed
   - 0 temporary directories removed
‚úÖ Test environment is clean


=================================== FAILURES ===================================
____________ TestGitBranchApplicationFacade.test_update_git_branch _____________
src/fastmcp/task_management/application/facades/git_branch_application_facade.py:211: in get_git_branch_by_id
    loop = asyncio.get_running_loop()
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
E   RuntimeError: no running event loop

During handling of the above exception, another exception occurred:
src/fastmcp/task_management/infrastructure/database/database_config.py:460: in _initialize_database
    database_url = self._get_database_url()
                   ^^^^^^^^^^^^^^^^^^^^^^^^
src/fastmcp/task_management/infrastructure/database/database_config.py:299: in _get_database_url
    raise ValueError(error_msg)
E   ValueError: ‚ùå DATABASE_PATH environment variable is NOT configured for SQLite!
E   When using DATABASE_TYPE=sqlite, you MUST specify DATABASE_PATH.
E   Please set DATABASE_PATH in your .env or .env.dev file:
E     Example: DATABASE_PATH=/data/agenthub.db
E     Or: DATABASE_PATH=./agenthub.db
E   No hardcoded paths will be used!

During handling of the above exception, another exception occurred:
src/tests/unit/task_management/application/facades/git_branch_application_facade_test.py:163: in test_update_git_branch
    result = facade.update_git_branch(
src/fastmcp/task_management/application/facades/git_branch_application_facade.py:137: in update_git_branch
    branch_result = self.get_git_branch_by_id(git_branch_id)
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/fastmcp/task_management/application/facades/git_branch_application_facade.py:238: in get_git_branch_by_id
    result = asyncio.run(self._find_git_branch_by_id(git_branch_id))
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib/python3.12/asyncio/runners.py:194: in run
    return runner.run(main)
           ^^^^^^^^^^^^^^^^
/usr/lib/python3.12/asyncio/runners.py:118: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib/python3.12/asyncio/base_events.py:674: in run_until_complete
    self.run_forever()
/usr/lib/python3.12/asyncio/base_events.py:641: in run_forever
    self._run_once()
/usr/lib/python3.12/asyncio/base_events.py:1987: in _run_once
    handle._run()
/usr/lib/python3.12/asyncio/events.py:88: in _run
    self._context.run(self._callback, *self._args)
src/fastmcp/task_management/application/facades/git_branch_application_facade.py:269: in _find_git_branch_by_id
    git_branch = await git_branch_repo.find_by_id(git_branch_id)
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/fastmcp/task_management/infrastructure/repositories/orm/git_branch_repository.py:176: in find_by_id
    with self.get_db_session() as session:
/usr/lib/python3.12/contextlib.py:137: in __enter__
    return next(self.gen)
           ^^^^^^^^^^^^^^
src/fastmcp/task_management/infrastructure/repositories/base_orm_repository.py:62: in get_db_session
    session = get_session()
              ^^^^^^^^^^^^^
src/fastmcp/task_management/infrastructure/database/database_config.py:601: in get_session
    return get_db_config().get_session()
           ^^^^^^^^^^^^^^^
src/fastmcp/task_management/infrastructure/database/database_config.py:582: in get_db_config
    _db_config = DatabaseConfig.get_instance()
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/fastmcp/task_management/infrastructure/database/database_config.py:135: in get_instance
    cls._instance = cls()
                    ^^^^^
src/fastmcp/task_management/infrastructure/database/database_config.py:228: in __init__
    self._initialize_database()
src/fastmcp/task_management/infrastructure/database/database_config.py:498: in _initialize_database
    sys.exit(1)
E   SystemExit: 1
---------------------------- Captured stdout setup -----------------------------

‚ö° Skipping database setup for unit test
----------------------------- Captured stdout call -----------------------------
2025-09-25 02:40:13,696 - fastmcp.task_management.application.facades.git_branch_application_facade - INFO - Getting git branch by ID: branch-id-123
2025-09-25 02:40:13,696 - fastmcp.task_management.infrastructure.repositories.repository_factory - WARNING - SQLiteGitBranchRepository not available, falling back to ORM
2025-09-25 02:40:13,696 - fastmcp.task_management.infrastructure.repositories.orm.git_branch_repository - INFO - ORMGitBranchRepository initialized for user: test-user-id, performance_mode: False
2025-09-25 02:40:13,696 - fastmcp.task_management.infrastructure.repositories.repository_factory - INFO - [RepositoryFactory] Using ORMGitBranchRepository (fallback)
2025-09-25 02:40:13,724 - fastmcp.task_management.infrastructure.repositories.repository_factory - INFO - [RepositoryFactory] Wrapping with CachedGitBranchRepository
2025-09-25 02:40:13,724 - fastmcp.task_management.infrastructure.repositories.cached.cached_git_branch_repository - WARNING - [CachedGitBranchRepository] Redis not available, caching disabled: Error 111 connecting to localhost:6379. Connection refused.
2025-09-25 02:40:13,724 - fastmcp.task_management.infrastructure.repositories.git_branch_repository_factory - INFO - Created git branch repository: orm for user: test-user-id
2025-09-25 02:40:13,725 - fastmcp.task_management.infrastructure.database.database_config - INFO - üì¶ SQLite mode enabled for development/testing
2025-09-25 02:40:13,725 - fastmcp.task_management.infrastructure.database.database_config - INFO - Database type: sqlite
2025-09-25 02:40:13,725 - fastmcp.task_management.infrastructure.database.database_config - ERROR - ‚ùå DATABASE_PATH environment variable is NOT configured for SQLite!
When using DATABASE_TYPE=sqlite, you MUST specify DATABASE_PATH.
Please set DATABASE_PATH in your .env or .env.dev file:
  Example: DATABASE_PATH=/data/agenthub.db
  Or: DATABASE_PATH=./agenthub.db
No hardcoded paths will be used!
2025-09-25 02:40:13,725 - fastmcp.task_management.infrastructure.database.database_config - ERROR - ‚ùå CRITICAL: Failed to initialize database: ‚ùå DATABASE_PATH environment variable is NOT configured for SQLite!
When using DATABASE_TYPE=sqlite, you MUST specify DATABASE_PATH.
Please set DATABASE_PATH in your .env or .env.dev file:
  Example: DATABASE_PATH=/data/agenthub.db
  Or: DATABASE_PATH=./agenthub.db
No hardcoded paths will be used!
2025-09-25 02:40:13,725 - fastmcp.task_management.infrastructure.database.database_config - ERROR - Database configuration that failed:
2025-09-25 02:40:13,725 - fastmcp.task_management.infrastructure.database.database_config - ERROR -   DATABASE_TYPE: sqlite
2025-09-25 02:40:13,725 - fastmcp.task_management.infrastructure.database.database_config - ERROR -   DATABASE_HOST: localhost
2025-09-25 02:40:13,725 - fastmcp.task_management.infrastructure.database.database_config - ERROR -   DATABASE_NAME: postgresdb
2025-09-25 02:40:13,725 - fastmcp.task_management.infrastructure.database.database_config - ERROR - Server MUST stop - no fallback allowed!
------------------------------ Captured log call -------------------------------
INFO     fastmcp.task_management.application.facades.git_branch_application_facade:git_branch_application_facade.py:203 Getting git branch by ID: branch-id-123
WARNING  fastmcp.task_management.infrastructure.repositories.repository_factory:repository_factory.py:191 SQLiteGitBranchRepository not available, falling back to ORM
INFO     fastmcp.task_management.infrastructure.repositories.orm.git_branch_repository:git_branch_repository.py:59 ORMGitBranchRepository initialized for user: test-user-id, performance_mode: False
INFO     fastmcp.task_management.infrastructure.repositories.repository_factory:repository_factory.py:211 [RepositoryFactory] Using ORMGitBranchRepository (fallback)
INFO     fastmcp.task_management.infrastructure.repositories.repository_factory:repository_factory.py:217 [RepositoryFactory] Wrapping with CachedGitBranchRepository
WARNING  fastmcp.task_management.infrastructure.repositories.cached.cached_git_branch_repository:cached_git_branch_repository.py:51 [CachedGitBranchRepository] Redis not available, caching disabled: Error 111 connecting to localhost:6379. Connection refused.
INFO     fastmcp.task_management.infrastructure.repositories.git_branch_repository_factory:git_branch_repository_factory.py:66 Created git branch repository: orm for user: test-user-id
INFO     fastmcp.task_management.infrastructure.database.database_config:database_config.py:200 üì¶ SQLite mode enabled for development/testing
INFO     fastmcp.task_management.infrastructure.database.database_config:database_config.py:218 Database type: sqlite
ERROR    fastmcp.task_management.infrastructure.database.database_config:database_config.py:298 ‚ùå DATABASE_PATH environment variable is NOT configured for SQLite!
When using DATABASE_TYPE=sqlite, you MUST specify DATABASE_PATH.
Please set DATABASE_PATH in your .env or .env.dev file:
  Example: DATABASE_PATH=/data/agenthub.db
  Or: DATABASE_PATH=./agenthub.db
No hardcoded paths will be used!
ERROR    fastmcp.task_management.infrastructure.database.database_config:database_config.py:489 ‚ùå CRITICAL: Failed to initialize database: ‚ùå DATABASE_PATH environment variable is NOT configured for SQLite!
When using DATABASE_TYPE=sqlite, you MUST specify DATABASE_PATH.
Please set DATABASE_PATH in your .env or .env.dev file:
  Example: DATABASE_PATH=/data/agenthub.db
  Or: DATABASE_PATH=./agenthub.db
No hardcoded paths will be used!
ERROR    fastmcp.task_management.infrastructure.database.database_config:database_config.py:490 Database configuration that failed:
ERROR    fastmcp.task_management.infrastructure.database.database_config:database_config.py:491   DATABASE_TYPE: sqlite
ERROR    fastmcp.task_management.infrastructure.database.database_config:database_config.py:492   DATABASE_HOST: localhost
ERROR    fastmcp.task_management.infrastructure.database.database_config:database_config.py:493   DATABASE_NAME: postgresdb
ERROR    fastmcp.task_management.infrastructure.database.database_config:database_config.py:494 Server MUST stop - no fallback allowed!
=============================== warnings summary ===============================
src/tests/conftest.py:264
  /home/daihungpham/__projects__/4genthub/agenthub_main/src/tests/conftest.py:264: PytestCollectionWarning: cannot collect test class 'MockFastAPIClient' because it has a __init__ constructor (from: unit/auth/interface/auth_endpoints_test.py)
    class MockFastAPIClient:

../../../.local/lib/python3.12/site-packages/pydantic/_internal/_generate_schema.py:298
../../../.local/lib/python3.12/site-packages/pydantic/_internal/_generate_schema.py:298
../../../.local/lib/python3.12/site-packages/pydantic/_internal/_generate_schema.py:298
../../../.local/lib/python3.12/site-packages/pydantic/_internal/_generate_schema.py:298
../../../.local/lib/python3.12/site-packages/pydantic/_internal/_generate_schema.py:298
../../../.local/lib/python3.12/site-packages/pydantic/_internal/_generate_schema.py:298
../../../.local/lib/python3.12/site-packages/pydantic/_internal/_generate_schema.py:298
  /home/daihungpham/.local/lib/python3.12/site-packages/pydantic/_internal/_generate_schema.py:298: PydanticDeprecatedSince20: `json_encoders` is deprecated. See https://docs.pydantic.dev/2.11/concepts/serialization/#custom-serializers for alternatives. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.11/migration/
    warnings.warn(

unit/task_management/application/facades/git_branch_application_facade_test.py::TestGitBranchApplicationFacade::test_create_git_branch_sync_in_event_loop
  /usr/lib/python3.12/unittest/mock.py:2188: RuntimeWarning: coroutine 'AsyncMockMixin._execute_mock_call' was never awaited
    def __init__(self, name, parent):
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

unit/task_management/application/facades/git_branch_application_facade_test.py::TestGitBranchApplicationFacade::test_update_git_branch
  /usr/lib/python3.12/typing.py:1246: RuntimeWarning: coroutine 'AsyncMockMixin._execute_mock_call' was never awaited
    self.__args__ = tuple(... if a is _TypingEllipsis else
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ============================
FAILED src/tests/unit/task_management/application/facades/git_branch_application_facade_test.py::TestGitBranchApplicationFacade::test_update_git_branch
!!!!!!!!!!!!!!!!!!!!!!!!!! stopping after 1 failures !!!!!!!!!!!!!!!!!!!!!!!!!!!
================= 1 failed, 1030 passed, 10 warnings in 7.19s ==================
